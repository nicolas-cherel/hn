function Node(e,t,n,o){this.content=e,this.depth=n,this.children=t||[],this.nodeType=o,this.depth_helper=Array.apply(null,Array(n))}var Component=require("montage/ui/component").Component,TimeAgoConverter=require("lib/time-ago-converter").TimeAgoConverter,fetchKids=function(e,t,n,o){var r,i=t||0,a=n||10,l=[],c=(o||0)+3,s=(r=e,r=r&&r.content,r&&r.kids);return s&&s.slice(i,i+a).forEach(function(t,n){var o=new Firebase("https://hacker-news.firebaseio.com/v0/item/"+t);(function(e,t){l.push(new Promise(function(n){var o=e.on("value",function(r){var i=r.val(),a=new Node(i,null,t.depth+1,i.type);e.off("value",o),n(a)})}))})(o,e,n)}),s&&s.length-i>a&&l.push(new Promise(function(t){t(new Node({parent:e},null,e.depth,"more-next-placeholder"))})),Promise.all(l).then(function(t){return Promise.all(t.map(function(e){return e&&e.content&&e.content.kids&&e.content.kids.length>0?c+1>e.depth?fetchKids(e,0,null,o):new Promise(function(t){e.children.push(new Node({parent:e},null,e.depth,"more-replies-placeholder")),t()}):void 0})).then(function(){t.forEach(function(t){e.children.push(t)})})})};exports.Comments=Component.specialize({constructor:{value:function(){this.super(),this.addPathChangeListener("itemId",this,"_loadStory")}},time_ago_converter:{value:new TimeAgoConverter},handleClick:{value:function(e){var t;if(e.target.component&&(t=e.target.component.nodeData)){t.content.parent.content;var n=t.content.parent.children.length-1,o=t.content.parent.depth;fetchKids(t.content.parent,n,null,o).then(function(){t.content.parent.children.splice(n,1)}),e.stopPropagation(),e.preventDefault()}}},_loadStory:{value:function(){if(!this.itemId)return this.story=null,void 0;var e=new Firebase("https://hacker-news.firebaseio.com/v0/item/"+this.itemId),t=this;new Promise(function(t){var n=e.on("value",function(o){o.val()&&(node=new Node(o.val(),null,0,o.val().type),e.off("value",n),fetchKids(node).then(function(){t(node)}))})}).then(function(e){t.story=e})}},enterDocument:{value:function(e){e&&this.element.addEventListener("click",this,!1)}}});